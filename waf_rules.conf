# SQL Injection protection
set $block_sql_injection 0;
if ($query_string ~* "union.*select.*\(") {
    set $block_sql_injection 1;
}
if ($query_string ~* "concat.*\(") {
    set $block_sql_injection 1;
}
if ($query_string ~* "[\;\|\`]\W*?\b(exec|execute|shutdown)") {
    set $block_sql_injection 1;
}

# XSS protection
set $block_xss 0;
if ($query_string ~* "<script.*>") {
    set $block_xss 1;
}
if ($query_string ~* "javascript:") {
    set $block_xss 1;
}
if ($query_string ~* "onmouseover|onload|onerror|onclick") {
    set $block_xss 1;
}

# RCE protection
set $block_rce 0;
if ($query_string ~* "(\/bin\/bash|wget|curl|lynx|nc|perl|python|php|ruby)") {
    set $block_rce 1;
}
if ($query_string ~* "(\.\.\/|\.\/|\\0|file\:\/\/|php\:\/\/)") {
    set $block_rce 1;
}

# Combined block
if ($block_sql_injection = 1) {
    return 403;
}
if ($block_xss = 1) {
    return 403;
}
if ($block_rce = 1) {
    return 403;
}

# Block common bots and scanners
if ($http_user_agent ~* (nmap|nikto|wikto|sf|sqlmap|bsqlbf|w3af|acunetix|havij|libwww-perl|wget|python|nikto|curl|scan|java|winhttp|HTTrack|clshttp|archiver|loader|email|harvest|extract|grab|miner)) {
    return 403;
}

